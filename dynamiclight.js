"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const event_1 = require("bdsx/event");
const utils_1 = require("./utils");
const blockpos_1 = require("bdsx/bds/blockpos");
const block_1 = require("bdsx/bds/block");
const launcher_1 = require("bdsx/launcher");
const Lights = new Map();
const Items = new Map();
async function Load() {
    Lights.clear();
    for (const [key, value] of (0, utils_1.StringToMap)((0, utils_1.LoadFile)(utils_1.TypePath.world, "", "lights"), "id")) {
        Lights.set(key, value);
    }
    console.log(`[${utils_1.plugin.name}] `.magenta + `Lights currently active: ${Lights.size}`);
    Items.clear();
    for (const [key, value] of (0, utils_1.StringToMap)((0, utils_1.LoadFile)(utils_1.TypePath.plugin, "", "items"), "name")) {
        Items.set(key, value);
    }
    console.log(`[${utils_1.plugin.name}] `.magenta + `Items with light: ${Items.size}`);
}
Load();
function Save() {
    (0, utils_1.SaveFile)(utils_1.TypePath.world, "", "lights", (0, utils_1.MapToString)(Lights));
}
const save_thred = setInterval(function () {
    Save();
}, 30 * 1000);
function getBlockAir(entity, dir = 0) {
    const region = entity.getRegion();
    const pos = entity.getPosition();
    let blockpos = blockpos_1.BlockPos.create(Math.floor(pos.x), Math.floor(pos.y), Math.floor(pos.z));
    switch (dir) {
        case 0:
            blockpos = blockpos_1.BlockPos.create(Math.floor(pos.x), Math.floor(pos.y), Math.floor(pos.z));
            break;
        case 1:
            blockpos = blockpos_1.BlockPos.create(Math.floor(pos.x), Math.floor(pos.y + 1), Math.floor(pos.z));
            break;
        case 2:
            blockpos = blockpos_1.BlockPos.create(Math.floor(pos.x), Math.floor(pos.y - 1), Math.floor(pos.z));
            break;
        case 3:
            blockpos = blockpos_1.BlockPos.create(Math.floor(pos.x + 1), Math.floor(pos.y), Math.floor(pos.z));
            break;
        case 4:
            blockpos = blockpos_1.BlockPos.create(Math.floor(pos.x - 1), Math.floor(pos.y), Math.floor(pos.z));
            break;
        case 5:
            blockpos = blockpos_1.BlockPos.create(Math.floor(pos.x), Math.floor(pos.y), Math.floor(pos.z + 1));
            break;
        case 6:
            blockpos = blockpos_1.BlockPos.create(Math.floor(pos.x), Math.floor(pos.y), Math.floor(pos.z - 1));
            break;
        default:
            return false;
    }
    const block = region.getBlock(blockpos);
    if (block.getName() == "minecraft:air" || block.getName() == "minecraft:light_block" || block.getName() == "minecraft:water")
        return blockpos;
    return getBlockAir(entity, (dir + 1));
}
async function setLightHandItem(entity) {
    if (Items.has(entity.getMainhandSlot().getName())) {
        const blockpos = getBlockAir(entity);
        if (blockpos) {
            const item = Items.get(entity.getMainhandSlot().getName());
            const id = `${blockpos.x}_${blockpos.y}_${blockpos.z}`;
            Lights.set(`${id}`, { id: `${id}`, underwater: item.underwater, x: blockpos.x, y: blockpos.y, z: blockpos.z, time: (0, utils_1.Time)(0.5), light: item.light });
            const block = block_1.Block.create('minecraft:light_block', item.light);
            entity.getRegion().setBlock(blockpos, block);
        }
    }
}
async function setLightEntityItem(entity) {
    if (Items.has(entity.itemStack.getName())) {
        const blockpos = getBlockAir(entity);
        if (blockpos) {
            const item = Items.get(entity.itemStack.getName());
            const id = `${blockpos.x}_${blockpos.y}_${blockpos.z}`;
            Lights.set(`${id}`, { id: `${id}`, underwater: item.underwater, x: blockpos.x, y: blockpos.y, z: blockpos.z, time: (0, utils_1.Time)(0.5), light: item.light });
            const block = block_1.Block.create('minecraft:light_block', item.light);
            entity.getRegion().setBlock(blockpos, block);
        }
    }
}
const thred = setInterval(function () {
    launcher_1.bedrockServer.level.getEntities().forEach((actor) => {
        if (actor.isMob()) {
            setLightHandItem(actor);
        }
        else if (actor.isItem()) {
            setLightEntityItem(actor);
        }
    });
    launcher_1.bedrockServer.level.getPlayers().forEach((player) => {
        setLightHandItem(player);
        const region = player.getRegion();
        for (const data of Lights.values()) {
            if ((0, utils_1.Time)() > data.time) {
                const blockpos = blockpos_1.BlockPos.create(data.x, data.y, data.z);
                const light = region.getBlock(blockpos);
                if (light.getName() == "minecraft:light_block") {
                    const block = block_1.Block.create('minecraft:air');
                    if (region.setBlock(blockpos, block)) {
                        Lights.delete(`${blockpos.x}_${blockpos.y}_${blockpos.z}`);
                    }
                }
            }
        }
    });
}, 500);
event_1.events.serverClose.on(() => {
    clearInterval(thred);
    clearInterval(save_thred);
    Save();
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZHluYW1pY2xpZ2h0LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiZHluYW1pY2xpZ2h0LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQUEsc0NBQW9DO0FBQ3BDLG1DQUErRjtBQUMvRixnREFBNkM7QUFDN0MsMENBQXVDO0FBRXZDLDRDQUE4QztBQUU5QyxNQUFNLE1BQU0sR0FBRyxJQUFJLEdBQUcsRUFBVyxDQUFDO0FBQ2xDLE1BQU0sS0FBSyxHQUFHLElBQUksR0FBRyxFQUFXLENBQUM7QUFFakMsS0FBSyxVQUFVLElBQUk7SUFDZixNQUFNLENBQUMsS0FBSyxFQUFFLENBQUM7SUFDZixLQUFLLE1BQU0sQ0FBQyxHQUFHLEVBQUUsS0FBSyxDQUFDLElBQUksSUFBQSxtQkFBVyxFQUFDLElBQUEsZ0JBQVEsRUFBQyxnQkFBUSxDQUFDLEtBQUssRUFBRSxFQUFFLEVBQUUsUUFBUSxDQUFDLEVBQUUsSUFBSSxDQUFDLEVBQUU7UUFDbEYsTUFBTSxDQUFDLEdBQUcsQ0FBQyxHQUFHLEVBQUUsS0FBSyxDQUFDLENBQUM7S0FDMUI7SUFFRCxPQUFPLENBQUMsR0FBRyxDQUFDLElBQUksY0FBTSxDQUFDLElBQUksSUFBSSxDQUFDLE9BQU8sR0FBRyw0QkFBNEIsTUFBTSxDQUFDLElBQUksRUFBRSxDQUFDLENBQUM7SUFFckYsS0FBSyxDQUFDLEtBQUssRUFBRSxDQUFDO0lBQ2QsS0FBSyxNQUFNLENBQUMsR0FBRyxFQUFFLEtBQUssQ0FBQyxJQUFJLElBQUEsbUJBQVcsRUFBQyxJQUFBLGdCQUFRLEVBQUMsZ0JBQVEsQ0FBQyxNQUFNLEVBQUUsRUFBRSxFQUFFLE9BQU8sQ0FBQyxFQUFFLE1BQU0sQ0FBQyxFQUFFO1FBQ3BGLEtBQUssQ0FBQyxHQUFHLENBQUMsR0FBRyxFQUFFLEtBQUssQ0FBQyxDQUFDO0tBQ3pCO0lBRUQsT0FBTyxDQUFDLEdBQUcsQ0FBQyxJQUFJLGNBQU0sQ0FBQyxJQUFJLElBQUksQ0FBQyxPQUFPLEdBQUcscUJBQXFCLEtBQUssQ0FBQyxJQUFJLEVBQUUsQ0FBQyxDQUFDO0FBQ2pGLENBQUM7QUFFRCxJQUFJLEVBQUUsQ0FBQztBQUVQLFNBQVMsSUFBSTtJQUNULElBQUEsZ0JBQVEsRUFBQyxnQkFBUSxDQUFDLEtBQUssRUFBQyxFQUFFLEVBQUMsUUFBUSxFQUFDLElBQUEsbUJBQVcsRUFBQyxNQUFNLENBQUMsQ0FBQyxDQUFDO0FBQzdELENBQUM7QUFFRCxNQUFNLFVBQVUsR0FBRyxXQUFXLENBQUM7SUFDM0IsSUFBSSxFQUFFLENBQUM7QUFDWCxDQUFDLEVBQUUsRUFBRSxHQUFDLElBQUksQ0FBQyxDQUFDO0FBRVosU0FBUyxXQUFXLENBQUMsTUFBYSxFQUFFLE1BQWMsQ0FBQztJQUMvQyxNQUFNLE1BQU0sR0FBRyxNQUFNLENBQUMsU0FBUyxFQUFFLENBQUM7SUFDbEMsTUFBTSxHQUFHLEdBQUcsTUFBTSxDQUFDLFdBQVcsRUFBRSxDQUFDO0lBQ2pDLElBQUksUUFBUSxHQUFHLG1CQUFRLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxFQUFFLElBQUksQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxFQUFFLElBQUksQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7SUFDeEYsUUFBTyxHQUFHLEVBQUM7UUFDUCxLQUFLLENBQUM7WUFDRixRQUFRLEdBQUcsbUJBQVEsQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLEVBQUUsSUFBSSxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLEVBQUUsSUFBSSxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztZQUNwRixNQUFNO1FBQ1YsS0FBSyxDQUFDO1lBQ0YsUUFBUSxHQUFHLG1CQUFRLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxFQUFFLElBQUksQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUMsR0FBQyxDQUFDLENBQUMsRUFBRSxJQUFJLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBQ3RGLE1BQU07UUFDVixLQUFLLENBQUM7WUFDRixRQUFRLEdBQUcsbUJBQVEsQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLEVBQUUsSUFBSSxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQyxHQUFDLENBQUMsQ0FBQyxFQUFFLElBQUksQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFDdEYsTUFBTTtRQUNWLEtBQUssQ0FBQztZQUNGLFFBQVEsR0FBRyxtQkFBUSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDLEdBQUMsQ0FBQyxDQUFDLEVBQUUsSUFBSSxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLEVBQUUsSUFBSSxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztZQUN0RixNQUFNO1FBQ1YsS0FBSyxDQUFDO1lBQ0YsUUFBUSxHQUFHLG1CQUFRLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUMsR0FBQyxDQUFDLENBQUMsRUFBRSxJQUFJLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsRUFBRSxJQUFJLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBQ3RGLE1BQU07UUFDVixLQUFLLENBQUM7WUFDRixRQUFRLEdBQUcsbUJBQVEsQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLEVBQUUsSUFBSSxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLEVB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